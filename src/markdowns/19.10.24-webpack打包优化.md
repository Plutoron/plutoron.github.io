### webpack 配置打包优化

#### 样式提取及压缩

*mini-css-extract-plugin*将css文件提取成一个文件
*optimize-css-assets-webpack-plugin* 压缩css文件

```

*mini-css-extract-plugin*将css文件提取成一个文件
const MiniCssExtractPlugin = require('mini-css-extract-plugin') // css 并合并成 文件

module: {
  rules: [
    {
      test: /\.(le|c)ss$/,
      use: [
        // 添加 环境判断 变量 只有生产环境 使用 MiniCssExtractPlugin
        isDEV ? 'style-loader' : MiniCssExtractPlugin.loader,
        'css-loader', 
        { 
          loader: 'postcss-loader',
          options: {
            plugins: loader => [
              require('autoprefixer')(), // CSS浏览器兼容 需要package.json 添加 对应的 browserslist,也有其他方式，自行搜索
            ]
          }
        },
        `less-loader?{"sourceMap":true, "modifyVars":${JSON.stringify(theme)}, "javascriptEnabled": true}`,
      ], // 注意排列顺序，执行顺序与排列顺序相反
    },
  ],
}

plugins: [
  ...,
  ...(isDEV ? 
    []
    : [
      new MiniCssExtractPlugin({
        filename: '[name].css',
        // 将相关模块的 样式分离，生成不同的文件，按需加载 css下载变小，加快页面加载
        chunkFilename: '[name].[contenthash].css' 
      }),
    ]
  ),
  ...,
],

*optimize-css-assets-webpack-plugin* 压缩css文件

optimization: {
  minimizer: [
    // 混淆 js
    new UglifyJsPlugin({
      uglifyOptions: {
        compress: {
          drop_console: true,
        },
        ecma: 5,
      },
      cache: true,
      parallel: true,
      sourceMap: true,
    }),
    // 压缩css
    new OptimizeCSSAssetsPlugin({
      assetNameRegExp: /\.css$/g,
      cssProcessorOptions: {
        // const safeParser = require('postcss-safe-parser') 添加前缀的规则
        parser: safeParser, 
        discardComments: {
          removeAll: true,
        },
      },
    }),
  ],
},
```

#### js模块打包拆分

##### common.js 提取

```
optimization: {
  splitChunks: {
    cacheGroups: {
      common: {
        test: /[\\/]node_modules[\\/] || src\//,
        chunks: 'all',
        name: 'common',
        minSize: 0,
        minChunks: 2,
        priority: 10, //优先级
        enforce: true,
      },
    },
  },
}
```

##### react、react-dom、react-router-dom 等公用模块 走CDN

> 将我们用到的依赖 通过外部cdn的方式引入，打包时不打包，减少打包体积大小，将它们从package.json里面删掉

```
externals: {
  react: 'React',
  'react-dom': 'ReactDOM',
  'react-router-dom': 'ReactRouterDOM',
},
plugins: [
  ...,
  new HtmlWebpackPlugin({
    jsCdns: [
      'https://cdn.jsdelivr.net/npm/react@16.10.2/umd/react.production.min.js',
      'https://cdn.jsdelivr.net/npm/react-dom@16.10.2/umd/react-dom.production.min.js',
      'https://cdn.jsdelivr.net/npm/react-router-dom@5.1.2/umd/react-router-dom.min.js',
    ],
    template: './template/index.html',
    minify: {
      collapseWhitespace: true, // 折叠空白
      removeComments: true, // 移除注释
      removeAttributeQuotes: true // 移除属性的引号
    }
  }),
  ...,
],
```
**模版对应修改*
```
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>suyunlonsy</title>
</head>
<body>
  <div id="app"></div>
  
  <% htmlWebpackPlugin.options.jsCdns.map(item => {{ %>
    <script type="text/javascript" src="<%= item %>"></script>
  <% }}) %>
</body>
</html>
```

#### 配置 resolve 优化 加载解析速度

```
resolve: {
  alias: {
    src: resolve('src'),
    common: resolve('src/common'),
    images: resolve('src/images'),
    markdowns: resolve('src/markdowns'),
    mods: resolve('src/components'),
  },
  extensions: ['.js', '.jsx', 'css']
},
```